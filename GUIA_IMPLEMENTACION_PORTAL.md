# üöÄ GU√çA DE IMPLEMENTACI√ìN - Portal de Usuarios con Sistema de Login

## üìã Resumen

Has solicitado mejorar el portal de facturaci√≥n con las siguientes caracter√≠sticas:

1. ‚úÖ **Crear tabla `facturas`** en PostgreSQL
2. ‚úÖ **Sistema de usuarios** con login (email + receiver_id)
3. ‚úÖ **Creaci√≥n autom√°tica de usuarios** cuando solicitan factura
4. ‚úÖ **Portal de clientes** donde ven sus facturas, PDFs, XMLs
5. ‚úÖ **Workflow n8n actualizado** para crear usuario y responder con credenciales

---

## üóÑÔ∏è PASO 1: Crear las Tablas en PostgreSQL

### Ejecutar el schema SQL:

```bash
cd /home/dml/portal_facturacion

# Conectar a PostgreSQL y ejecutar
psql -h 192.168.80.8 -p 30432 -U dml -d mercadoLibre -f database_schema.sql
```

**O manualmente:**

```bash
psql -h 192.168.80.8 -p 30432 -U dml -d mercadoLibre
```

Luego dentro de psql:

```sql
\i database_schema.sql
```

### Tablas creadas:

1. **usuarios_portal** - Usuarios del portal (login con email + receiver_id)
2. **facturas** - Todas las facturas generadas
3. **sesiones_portal** - Control de sesiones
4. **historial_accesos** - Log de accesos
5. **notificaciones** - Notificaciones para usuarios

### Verificar que se crearon:

```sql
\dt
-- Debe mostrar: usuarios_portal, facturas, sesiones_portal, historial_accesos, notificaciones

SELECT * FROM usuarios_portal;
SELECT * FROM facturas;
```

---

## üîß PASO 2: Actualizar app.py

### Opci√≥n A: Agregar receiver_id al payload

Necesitas modificar `app.py` para incluir el `receiver_id` que viene de la tabla `orden_ml`.

**Modificar funci√≥n `buscar_pedido()` (l√≠nea 58):**

```python
def buscar_pedido(search_id):
    """
    Busca un pedido por order_id, pack_id o payment_id
    ACTUALIZADO: Ahora incluye receiver_id y shipment_id
    """
    conn = get_db_connection()
    if not conn:
        return None

    cursor = None
    try:
        cursor = conn.cursor()

        # Incluir receiver_id y shipment_id en la consulta
        query = """
            SELECT order_id, paid_amount, buyer_nickname, currency_id,
                   receiver_id, shipment_id
            FROM public.orden_ml
            WHERE order_id = %s OR pack_id = %s
        """
        cursor.execute(query, (search_id, search_id))
        row = cursor.fetchone()

        if not row:
            query = """
                SELECT order_id, paid_amount, buyer_nickname, currency_id,
                       receiver_id, shipment_id
                FROM public.orden_ml
                WHERE payments_0_id = %s
            """
            cursor.execute(query, (search_id,))
            row = cursor.fetchone()

        if row:
            return {
                'order_id': row[0],
                'paid_amount': float(row[1]) if row[1] else 0,
                'buyer_nickname': row[2],
                'currency_id': row[3],
                'receiver_id': row[4],  # ‚Üê NUEVO
                'shipment_id': row[5]   # ‚Üê NUEVO
            }
        return None

    except psycopg2.Error as e:
        app.logger.error(f"Error buscando pedido: {e}")
        return None
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
```

**Modificar funci√≥n `procesar_factura()` (l√≠nea 404):**

Agregar al payload:

```python
    # Payload para n8n
    payload = {
        # Datos del pedido
        'order_id': order['order_id'],
        'paid_amount': order['paid_amount'],
        'currency_id': order.get('currency_id', 'MXN'),

        # ‚Üê NUEVO: Datos del comprador
        'receiver_id': order.get('receiver_id'),
        'shipment_id': order.get('shipment_id'),
        'nombre': order.get('buyer_nickname', f"Cliente ML - {order['order_id']}"),

        # Datos de facturaci√≥n
        'email': email,
        'phone': phone,
        'cfdi_usage': cfdi_usage,
        'payment_method': payment_method,
        'monto_pagado': monto_pagado_float,

        # PDF de CSF (en base64)
        'csf_pdf': {
            'filename': filename,
            'content': pdf_content,
            'mime_type': 'application/pdf'
        },

        # Metadata
        'timestamp': datetime.now().isoformat(),
        'source': 'portal_flask'
    }
```

### Opci√≥n B: Integrar m√≥dulo de portal de usuarios

Puedes agregar el archivo `portal_usuarios.py` que ya est√° en el directorio:

**Al final de app.py, ANTES del `if __name__ == '__main__'`:**

```python
# ============================================================================
# PORTAL DE USUARIOS - SISTEMA DE LOGIN
# ============================================================================

from portal_usuarios import (
    login_required,
    portal_login,
    portal_login_post,
    portal_logout,
    portal_dashboard,
    portal_factura_detalle,
    portal_notificaciones,
    # ... importar todas las rutas necesarias
)

# O simplemente incluir todo el c√≥digo de portal_usuarios.py aqu√≠
```

**O ejecutar:**

```bash
cd /home/dml/portal_facturacion
cat portal_usuarios.py >> app.py
```

---

## üîÑ PASO 3: Workflow n8n YA ACTUALIZADO

El workflow **DWubtvcV5fyjkWGw** ya est√° actualizado con:

‚úÖ **15 nodos** (antes ten√≠a 14)
‚úÖ **Nuevo nodo:** "Crear/Actualizar Usuario Portal"
‚úÖ **Email actualizado** con credenciales de acceso
‚úÖ **Respuesta del webhook** incluye datos de acceso al portal

### Nodos agregados/modificados:

1. **Crear/Actualizar Usuario Portal** (despu√©s de Decodificar PDF)
   - Query SQL con `INSERT ... ON CONFLICT ... DO UPDATE`
   - Crea usuario o actualiza si ya existe
   - Usa receiver_id como contrase√±a

2. **Email mejorado** con:
   - Dise√±o HTML profesional
   - Credenciales de acceso al portal
   - URL del portal
   - Email + receiver_id para login

3. **Respuesta Success** ahora incluye:
   ```json
   {
     "success": true,
     "invoice_id": "12345",
     "order_id": "ABC123",
     "portal_access": {
       "url": "http://tu-dominio.com/portal",
       "email": "cliente@example.com",
       "password": "receiver_id_del_cliente",
       "mensaje": "Usa tu email y tu n√∫mero de cliente ML..."
     }
   }
   ```

---

## ‚öôÔ∏è PASO 4: Configurar Variables de Entorno

### En n8n, configurar variable de entorno:

1. Abre n8n: https://aut.automateai.com.mx
2. Settings ‚Üí Environment Variables
3. Agregar:

```
PORTAL_URL = http://tu-dominio.com/portal/login
```

O directamente en el servidor donde corre n8n:

```bash
export PORTAL_URL="http://tu-dominio.com/portal/login"
```

---

## üé® PASO 5: Crear Templates HTML

Crear en `/home/dml/portal_facturacion/templates/portal/`:

```bash
mkdir -p /home/dml/portal_facturacion/templates/portal
cd /home/dml/portal_facturacion/templates/portal
```

Necesitas crear:

1. **login.html** - P√°gina de login
2. **dashboard.html** - Dashboard principal con lista de facturas
3. **factura_detalle.html** - Ver una factura espec√≠fica
4. **notificaciones.html** - Ver notificaciones
5. **perfil.html** - Ver/editar perfil

### Ejemplo login.html:

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Facturas - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-5">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h4>Portal de Facturas DML Medica</h4>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form method="POST" action="{{ url_for('portal_login_post') }}">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="receiver_id" class="form-label">N√∫mero de Cliente ML</label>
                                <input type="text" class="form-control" id="receiver_id" name="receiver_id" required>
                                <small class="text-muted">Tu receiver_id de Mercado Libre</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Iniciar Sesi√≥n</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
```

---

## üß™ PASO 6: Probar el Sistema

### 1. Ejecutar SQL para crear tablas:

```bash
psql -h 192.168.80.8 -p 30432 -U dml -d mercadoLibre -f database_schema.sql
```

### 2. Actualizar app.py con receiver_id

Ver PASO 2 arriba.

### 3. Reiniciar Flask:

```bash
cd /home/dml/portal_facturacion
python3 app.py
```

### 4. Probar flujo completo:

1. Ir a http://localhost:5000
2. Buscar un pedido
3. Llenar formulario de facturaci√≥n
4. **Enviar** ‚Üí n8n procesa y crea usuario
5. **Revisar email** con credenciales
6. **Ir a** http://localhost:5000/portal/login
7. **Login** con email + receiver_id
8. **Ver dashboard** con facturas

---

## üìä Flujo Completo del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PORTAL FLASK (app.py)                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  1. Cliente busca pedido (order_id, pack_id, payment_id)      ‚îÇ
‚îÇ  2. Se obtiene receiver_id de orden_ml                         ‚îÇ
‚îÇ  3. Cliente llena formulario (email, tel√©fono, CSF PDF)        ‚îÇ
‚îÇ  4. Flask env√≠a todo a n8n via webhook                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  WORKFLOW N8N (15 nodos)                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  1. Webhook recibe datos                                        ‚îÇ
‚îÇ  2. Valida si ya existe factura (Postgres)                     ‚îÇ
‚îÇ     ‚îú‚îÄ SI ‚Üí Responde error                                     ‚îÇ
‚îÇ     ‚îî‚îÄ NO ‚Üí Contin√∫a                                           ‚îÇ
‚îÇ  3. Decodifica PDF de CSF                                      ‚îÇ
‚îÇ  4. **CREA/ACTUALIZA USUARIO en usuarios_portal** ‚Üê NUEVO     ‚îÇ
‚îÇ  5. Busca cliente en Odoo                                      ‚îÇ
‚îÇ  6. Crea cliente si no existe                                  ‚îÇ
‚îÇ  7. Crea factura en Odoo                                       ‚îÇ
‚îÇ  8. **GUARDA factura en tabla facturas con usuario_id** ‚Üê NUEVO‚îÇ
‚îÇ  9. Env√≠a email con:                                           ‚îÇ
‚îÇ     - PDF CSF adjunto                                          ‚îÇ
‚îÇ     - **Credenciales de acceso al portal** ‚Üê NUEVO            ‚îÇ
‚îÇ  10. Responde success con:                                     ‚îÇ
‚îÇ     - invoice_id                                               ‚îÇ
‚îÇ     - **portal_access (url, email, password)** ‚Üê NUEVO        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              PORTAL DE USUARIOS (portal_usuarios.py)            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  1. Cliente va a /portal/login                                 ‚îÇ
‚îÇ  2. Login con email + receiver_id                              ‚îÇ
‚îÇ  3. Dashboard muestra:                                         ‚îÇ
‚îÇ     - Lista de facturas                                        ‚îÇ
‚îÇ     - Estatus de pago                                          ‚îÇ
‚îÇ     - Observaciones de contabilidad                            ‚îÇ
‚îÇ     - Links para descargar PDF y XML                           ‚îÇ
‚îÇ  4. Cliente puede:                                             ‚îÇ
‚îÇ     - Ver detalle de facturas                                  ‚îÇ
‚îÇ     - Descargar PDF/XML                                        ‚îÇ
‚îÇ     - Ver notificaciones                                       ‚îÇ
‚îÇ     - Actualizar perfil (RFC, raz√≥n social, etc.)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê Sistema de Autenticaci√≥n

### C√≥mo funciona:

1. **Primera factura:**
   - Cliente solicita factura
   - n8n crea usuario en `usuarios_portal`
   - Password = receiver_id del comprador en Mercado Libre
   - Email enviado con credenciales

2. **Login:**
   - Cliente ingresa email + receiver_id
   - Sistema valida en tabla `usuarios_portal`
   - Si coincide, crea sesi√≥n

3. **Dashboard:**
   - Muestra facturas filtradas por `usuario_id`
   - Solo ve sus propias facturas

### Seguridad:

- ‚úÖ receiver_id es √∫nico por comprador
- ‚úÖ Historial de accesos registrado
- ‚úÖ Bloqueo temporal despu√©s de intentos fallidos
- ‚úÖ Sesiones con timeout
- ‚ö†Ô∏è **Para producci√≥n:** Usar HTTPS obligatorio

---

## üìÅ Archivos Creados

```
/home/dml/portal_facturacion/
‚îú‚îÄ‚îÄ app.py                          # Archivo principal (MODIFICAR)
‚îú‚îÄ‚îÄ portal_usuarios.py              # ‚úÖ NUEVO - Sistema de login
‚îú‚îÄ‚îÄ database_schema.sql             # ‚úÖ NUEVO - Schema SQL
‚îú‚îÄ‚îÄ GUIA_IMPLEMENTACION_PORTAL.md   # ‚úÖ NUEVO - Esta gu√≠a
‚îî‚îÄ‚îÄ templates/
    ‚îî‚îÄ‚îÄ portal/                     # ‚úÖ CREAR
        ‚îú‚îÄ‚îÄ login.html
        ‚îú‚îÄ‚îÄ dashboard.html
        ‚îú‚îÄ‚îÄ factura_detalle.html
        ‚îú‚îÄ‚îÄ notificaciones.html
        ‚îî‚îÄ‚îÄ perfil.html
```

---

## ‚úÖ Checklist de Implementaci√≥n

- [ ] **1. Ejecutar database_schema.sql en PostgreSQL**
- [ ] **2. Verificar que se crearon las 5 tablas**
- [ ] **3. Modificar app.py para incluir receiver_id**
- [ ] **4. Agregar portal_usuarios.py a app.py**
- [ ] **5. Crear templates HTML en templates/portal/**
- [ ] **6. Configurar PORTAL_URL en n8n**
- [ ] **7. Verificar que workflow n8n est√° activo (ya est√°)**
- [ ] **8. Probar flujo completo de solicitud de factura**
- [ ] **9. Probar login al portal**
- [ ] **10. Verificar que usuario puede ver sus facturas**

---

## üÜò Troubleshooting

### Error: "tabla facturas no existe"

```bash
# Verificar conexi√≥n
psql -h 192.168.80.8 -p 30432 -U dml -d mercadoLibre

# Dentro de psql
\dt

# Si no aparece, ejecutar:
\i /home/dml/portal_facturacion/database_schema.sql
```

### Error: "receiver_id no est√° en payload"

Modificar `buscar_pedido()` en app.py para incluir receiver_id (ver PASO 2).

### Error: "No se puede importar portal_usuarios"

```bash
# Verificar que est√° en el directorio
ls -lh /home/dml/portal_facturacion/portal_usuarios.py

# Agregar al inicio de app.py:
# from portal_usuarios import *
```

### Workflow n8n no crea usuario

Verificar credenciales de PostgreSQL en n8n y que el nodo "Crear/Actualizar Usuario Portal" tenga la consulta correcta.

---

## üìû Pr√≥ximos Pasos

1. Ejecutar `database_schema.sql`
2. Modificar `app.py` (agregar receiver_id)
3. Crear templates HTML
4. Probar flujo completo

¬øNecesitas ayuda con alg√∫n paso espec√≠fico?
